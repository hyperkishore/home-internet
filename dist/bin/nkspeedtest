#!/usr/bin/env node

const { spawn, execSync, spawnSync } = require('child_process');
const path = require('path');
const fs = require('fs');
const os = require('os');
const readline = require('readline');

const VERSION = '3.0.0';
const CONFIG_DIR = path.join(os.homedir(), '.config', 'nkspeedtest');
const DATA_DIR = path.join(os.homedir(), '.local', 'share', 'nkspeedtest');
const CONFIG_FILE = path.join(CONFIG_DIR, 'config.json');
const CSV_FILE = path.join(DATA_DIR, 'speed_log.csv');
const LOG_FILE = path.join(DATA_DIR, 'speed.log');
const PLIST_NAME = 'com.nkspeedtest.plist';
const PLIST_PATH = path.join(os.homedir(), 'Library', 'LaunchAgents', PLIST_NAME);
const SWIFTBAR_PLUGINS_DIR = path.join(os.homedir(), 'Library', 'Application Support', 'SwiftBar', 'Plugins');
const SWIFTBAR_PLUGIN_PATH = path.join(SWIFTBAR_PLUGINS_DIR, 'nkspeedtest.5m.sh');

// Colors
const colors = {
  red: (s) => `\x1b[31m${s}\x1b[0m`,
  green: (s) => `\x1b[32m${s}\x1b[0m`,
  yellow: (s) => `\x1b[33m${s}\x1b[0m`,
  blue: (s) => `\x1b[34m${s}\x1b[0m`,
  cyan: (s) => `\x1b[36m${s}\x1b[0m`,
};

function printHeader() {
  console.log(colors.cyan(`
╔═══════════════════════════════════════╗
║      NK Speed Test v${VERSION}            ║
╚═══════════════════════════════════════╝
`));
}

function usage() {
  printHeader();
  console.log(`Usage: nkspeedtest <command>

Commands:
  setup       Configure nkspeedtest (run this first)
  run         Run a speed test now
  start       Start automatic monitoring
  stop        Stop automatic monitoring
  status      Show status and recent results
  menubar     Install/update menu bar widget (SwiftBar)
  dashboard   Open dashboard in browser
  logs        View recent logs
  update      Update nkspeedtest to latest version
  uninstall   Remove configuration

Options:
  -h, --help     Show this help
  -v, --version  Show version
`);
}

function ensureDirs() {
  if (!fs.existsSync(CONFIG_DIR)) fs.mkdirSync(CONFIG_DIR, { recursive: true });
  if (!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR, { recursive: true });
}

function loadConfig() {
  if (fs.existsSync(CONFIG_FILE)) {
    return JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf8'));
  }
  return {};
}

function saveConfig(config) {
  ensureDirs();
  fs.writeFileSync(CONFIG_FILE, JSON.stringify(config, null, 2));
  fs.chmodSync(CONFIG_FILE, 0o600);
}

function isBrewInstalled() {
  try {
    execSync('which brew', { stdio: 'ignore' });
    return true;
  } catch {
    return false;
  }
}

function isPackageInstalled(pkg) {
  try {
    execSync(`brew list ${pkg}`, { stdio: 'ignore' });
    return true;
  } catch {
    return false;
  }
}

function installBrewPackage(pkg, cask = false) {
  const caskFlag = cask ? '--cask' : '';
  console.log(colors.blue(`Installing ${pkg}...`));
  try {
    execSync(`brew install ${caskFlag} ${pkg}`, { stdio: 'inherit' });
    console.log(colors.green(`${pkg} installed successfully`));
    return true;
  } catch (err) {
    console.log(colors.red(`Failed to install ${pkg}`));
    return false;
  }
}

function checkAndInstallDependencies() {
  if (!isBrewInstalled()) {
    console.log(colors.red('Homebrew is not installed.'));
    console.log('Install it from: https://brew.sh');
    process.exit(1);
  }

  // Check and install speedtest-cli
  if (!isPackageInstalled('speedtest-cli')) {
    console.log(colors.yellow('speedtest-cli not found. Installing...'));
    if (!installBrewPackage('speedtest-cli')) {
      process.exit(1);
    }
  }
}

function checkAndInstallSwiftBar() {
  // Check if SwiftBar is installed
  if (!isPackageInstalled('swiftbar')) {
    console.log(colors.yellow('SwiftBar not found. Installing...'));
    if (!installBrewPackage('swiftbar', true)) {
      console.log(colors.red('Failed to install SwiftBar.'));
      console.log('You can install it manually: brew install --cask swiftbar');
      return false;
    }
  }
  return true;
}

async function prompt(question) {
  const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
  return new Promise((resolve) => {
    rl.question(question, (answer) => {
      rl.close();
      resolve(answer.trim());
    });
  });
}

async function promptYesNo(question, defaultYes = true) {
  const suffix = defaultYes ? '[Y/n]' : '[y/N]';
  const answer = await prompt(`${question} ${suffix}: `);
  if (!answer) return defaultYes;
  return answer.toLowerCase().startsWith('y');
}

async function cmdSetup() {
  printHeader();
  console.log(colors.green('Setting up nkspeedtest...\n'));

  // Install dependencies
  checkAndInstallDependencies();
  ensureDirs();

  const userName = await prompt('Enter your name/employee ID: ');
  if (!userName) {
    console.log(colors.red('Name is required'));
    process.exit(1);
  }

  const serverUrl = await prompt('Central server URL (or Enter for local-only): ');

  let apiKey = '';
  if (serverUrl) {
    apiKey = require('crypto').randomBytes(16).toString('hex');
    console.log(colors.yellow(`Your API key: ${apiKey}`));
  }

  const intervalMins = await prompt('Test interval in minutes [10]: ') || '10';

  const config = {
    userName,
    serverUrl,
    apiKey,
    interval: parseInt(intervalMins) * 60,
    version: VERSION,
  };

  saveConfig(config);

  // Initialize CSV with v2.0 schema
  const csvHeader = 'timestamp_utc,device_id,os_version,app_version,timezone,interface,ssid,bssid,band,channel,width_mhz,rssi_dbm,noise_dbm,snr_db,tx_rate_mbps,local_ip,public_ip,latency_ms,jitter_ms,jitter_p50,jitter_p95,packet_loss_pct,download_mbps,upload_mbps,vpn_status,vpn_name,errors,raw_payload';
  if (!fs.existsSync(CSV_FILE)) {
    fs.writeFileSync(CSV_FILE, csvHeader + '\n');
  }

  // Ask about menu bar widget
  const installMenuBar = await promptYesNo('\nInstall menu bar speed widget (SwiftBar)?', true);
  if (installMenuBar) {
    await cmdMenuBar();
  }

  console.log(colors.green('\nSetup complete!'));
  console.log(`
Next steps:
  1. Run 'npx nkspeedtest run' to test
  2. Run 'npx nkspeedtest start' to enable automatic monitoring
`);
}

function cmdRun() {
  const config = loadConfig();
  if (!config.userName) {
    console.log(colors.red('Not configured. Run "npx nkspeedtest setup" first.'));
    process.exit(1);
  }

  console.log(colors.blue('Running speed test (v2.0)...'));

  // Get device ID (persisted)
  const deviceIdFile = path.join(CONFIG_DIR, 'device_id');
  let deviceId;
  if (fs.existsSync(deviceIdFile)) {
    deviceId = fs.readFileSync(deviceIdFile, 'utf8').trim();
  } else {
    try {
      const hwUuid = execSync("ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformUUID/ { print $3 }' | tr -d '\"'", { encoding: 'utf8' }).trim();
      deviceId = require('crypto').createHash('sha256').update(hwUuid).digest('hex').substring(0, 16);
      fs.writeFileSync(deviceIdFile, deviceId);
    } catch {
      deviceId = require('crypto').randomBytes(8).toString('hex');
      fs.writeFileSync(deviceIdFile, deviceId);
    }
  }

  const timestampUtc = new Date().toISOString().replace('.000', '').replace(/\.\d{3}/, '');
  const osVersion = (() => { try { return execSync('sw_vers -productVersion', { encoding: 'utf8' }).trim(); } catch { return 'unknown'; } })();
  const timezone = new Date().toTimeString().match(/([+-]\d{4})/)?.[1] || '+0000';

  // Get WiFi details
  console.log(colors.blue('Collecting WiFi details...'));
  let wifiData = { interface: 'en0', ssid: 'Unknown/Ethernet', bssid: 'none', band: 'none', channel: 0, widthMhz: 0, rssiDbm: 0, noiseDbm: 0, snrDb: 0, txRateMbps: 0 };
  const wifiHelperPath = path.join(path.dirname(process.argv[1]), 'wifi_info');
  const altWifiHelper = path.join(os.homedir(), '.local', 'bin', 'wifi_info');

  try {
    let wifiOutput;
    if (fs.existsSync(wifiHelperPath)) {
      wifiOutput = execSync(wifiHelperPath, { encoding: 'utf8' });
    } else if (fs.existsSync(altWifiHelper)) {
      wifiOutput = execSync(altWifiHelper, { encoding: 'utf8' });
    }
    if (wifiOutput) {
      wifiOutput.split('\n').forEach(line => {
        const [key, val] = line.split('=');
        if (key === 'INTERFACE') wifiData.interface = val;
        if (key === 'SSID') wifiData.ssid = val;
        if (key === 'BSSID') wifiData.bssid = val;
        if (key === 'BAND') wifiData.band = val;
        if (key === 'CHANNEL') wifiData.channel = parseInt(val) || 0;
        if (key === 'WIDTH_MHZ') wifiData.widthMhz = parseInt(val) || 0;
        if (key === 'RSSI_DBM') wifiData.rssiDbm = parseInt(val) || 0;
        if (key === 'NOISE_DBM') wifiData.noiseDbm = parseInt(val) || 0;
        if (key === 'SNR_DB') wifiData.snrDb = parseInt(val) || 0;
        if (key === 'TX_RATE_MBPS') wifiData.txRateMbps = parseInt(val) || 0;
      });
    }
  } catch {}

  // VPN Detection
  console.log(colors.blue('Detecting VPN status...'));
  let vpnStatus = 'disconnected', vpnName = 'none';
  try {
    const processes = execSync('ps aux', { encoding: 'utf8' });
    if (/Zscaler|ZscalerTunnel/i.test(processes)) { vpnStatus = 'connected'; vpnName = 'Zscaler'; }
    else if (/vpnagentd/i.test(processes)) { vpnStatus = 'connected'; vpnName = 'Cisco AnyConnect'; }
    else if (/PanGPS|GlobalProtect/i.test(processes)) { vpnStatus = 'connected'; vpnName = 'GlobalProtect'; }
    else if (/FortiClient/i.test(processes)) { vpnStatus = 'connected'; vpnName = 'FortiClient'; }
    else if (/openvpn/i.test(processes)) { vpnStatus = 'connected'; vpnName = 'OpenVPN'; }
    else if (/wireguard-go/i.test(processes)) { vpnStatus = 'connected'; vpnName = 'WireGuard'; }
    else {
      const ifconfig = execSync('ifconfig 2>/dev/null', { encoding: 'utf8' });
      if (/^utun.*inet /m.test(ifconfig)) { vpnStatus = 'connected'; vpnName = 'Unknown VPN'; }
    }
  } catch {}

  // Jitter test (15 pings)
  console.log(colors.blue('Running jitter test...'));
  let jitterMs = 0, jitterP50 = 0, jitterP95 = 0, packetLossPct = 0;
  try {
    const pingOutput = execSync('ping -c 15 8.8.8.8', { encoding: 'utf8', timeout: 30000 });
    const rttValues = pingOutput.match(/time=(\d+\.?\d*)/g)?.map(m => parseFloat(m.replace('time=', ''))) || [];
    const lossMatch = pingOutput.match(/([\d.]+)% packet loss/);
    packetLossPct = lossMatch ? parseFloat(lossMatch[1]) : 0;
    if (rttValues.length > 1) {
      let sumDiff = 0;
      for (let i = 1; i < rttValues.length; i++) sumDiff += Math.abs(rttValues[i] - rttValues[i-1]);
      jitterMs = parseFloat((sumDiff / (rttValues.length - 1)).toFixed(2));
      const sorted = [...rttValues].sort((a, b) => a - b);
      jitterP50 = sorted[Math.floor(sorted.length * 0.5)];
      jitterP95 = sorted[Math.floor(sorted.length * 0.95)] || sorted[sorted.length - 1];
    }
  } catch {}

  // Network info
  const localIp = (() => { try { return execSync('ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null', { encoding: 'utf8' }).trim(); } catch { return 'unknown'; } })();
  let publicIp = 'unknown';
  try { publicIp = execSync('curl -s --max-time 5 ifconfig.me', { encoding: 'utf8' }).trim(); } catch {}

  // Speed test
  console.log(colors.blue('Running speed test...'));
  let latencyMs = 0, downloadMbps = 0, uploadMbps = 0, status = 'failed', errors = '';
  try {
    const result = execSync('speedtest-cli --simple', { encoding: 'utf8', timeout: 120000 });
    latencyMs = parseFloat(result.match(/Ping: ([\d.]+)/)?.[1] || '0');
    downloadMbps = parseFloat(result.match(/Download: ([\d.]+)/)?.[1] || '0');
    uploadMbps = parseFloat(result.match(/Upload: ([\d.]+)/)?.[1] || '0');
    status = 'success';
    console.log(colors.green(`Download: ${downloadMbps} Mbps`));
    console.log(colors.green(`Upload:   ${uploadMbps} Mbps`));
    console.log(colors.green(`Latency:  ${latencyMs} ms`));
    console.log(colors.cyan(`VPN:      ${vpnName} (${vpnStatus})`));
    console.log(colors.cyan(`Jitter:   ${jitterMs} ms (P50: ${jitterP50}, P95: ${jitterP95})`));
  } catch (err) {
    console.log(colors.red('Speed test failed'));
    errors = 'speedtest_failed';
  }

  // Build JSON payload
  const payload = {
    timestamp_utc: timestampUtc, device_id: deviceId, os_version: osVersion, app_version: VERSION,
    timezone, interface: wifiData.interface, ssid: wifiData.ssid, bssid: wifiData.bssid,
    band: wifiData.band, channel: wifiData.channel, width_mhz: wifiData.widthMhz,
    rssi_dbm: wifiData.rssiDbm, noise_dbm: wifiData.noiseDbm, snr_db: wifiData.snrDb,
    tx_rate_mbps: wifiData.txRateMbps, local_ip: localIp, public_ip: publicIp,
    latency_ms: latencyMs, jitter_ms: jitterMs, jitter_p50: jitterP50, jitter_p95: jitterP95,
    packet_loss_pct: packetLossPct, download_mbps: downloadMbps, upload_mbps: uploadMbps,
    vpn_status: vpnStatus, vpn_name: vpnName, errors
  };

  // v2.0 CSV header
  const csvHeader = 'timestamp_utc,device_id,os_version,app_version,timezone,interface,ssid,bssid,band,channel,width_mhz,rssi_dbm,noise_dbm,snr_db,tx_rate_mbps,local_ip,public_ip,latency_ms,jitter_ms,jitter_p50,jitter_p95,packet_loss_pct,download_mbps,upload_mbps,vpn_status,vpn_name,errors,raw_payload';

  ensureDirs();
  // Check if CSV needs header (new file or old format)
  if (!fs.existsSync(CSV_FILE) || !fs.readFileSync(CSV_FILE, 'utf8').startsWith('timestamp_utc')) {
    fs.writeFileSync(CSV_FILE, csvHeader + '\n');
  }

  const csvPayload = JSON.stringify(payload).replace(/"/g, '\\"');
  const csvLine = `${timestampUtc},${deviceId},${osVersion},${VERSION},${timezone},${wifiData.interface},${wifiData.ssid},${wifiData.bssid},${wifiData.band},${wifiData.channel},${wifiData.widthMhz},${wifiData.rssiDbm},${wifiData.noiseDbm},${wifiData.snrDb},${wifiData.txRateMbps},${localIp},${publicIp},${latencyMs},${jitterMs},${jitterP50},${jitterP95},${packetLossPct},${downloadMbps},${uploadMbps},${vpnStatus},${vpnName},${errors},"${csvPayload}"`;
  fs.appendFileSync(CSV_FILE, csvLine + '\n');

  // Send to server
  if (config.serverUrl) {
    sendToServerV2(config, payload);
  }

  fs.appendFileSync(LOG_FILE, `${timestampUtc} - ${status}\n`);
}

function sendToServer(config, data) {
  const payload = JSON.stringify({
    user_id: config.userName,
    hostname: data.hostname,
    timestamp: data.timestamp,
    download_mbps: parseFloat(data.download),
    upload_mbps: parseFloat(data.upload),
    ping_ms: parseFloat(data.ping),
    network_ssid: data.ssid,
    external_ip: data.externalIp,
    status: 'success',
  });

  try {
    execSync(`curl -s -X POST -H "Content-Type: application/json" -H "X-API-Key: ${config.apiKey}" -d '${payload}' "${config.serverUrl}/api/results"`, { timeout: 10000 });
    console.log(colors.green('Sent to server'));
  } catch {
    console.log(colors.yellow('Failed to send to server (data saved locally)'));
  }
}

function sendToServerV2(config, payload) {
  const jsonPayload = JSON.stringify(payload);
  try {
    execSync(`curl -s -X POST -H "Content-Type: application/json" -H "X-API-Key: ${config.apiKey}" -d '${jsonPayload.replace(/'/g, "'\\''")}' "${config.serverUrl}/api/results"`, { timeout: 10000 });
    console.log(colors.green('Sent to server'));
  } catch {
    console.log(colors.yellow('Failed to send to server (data saved locally)'));
  }
}

function cmdStart() {
  const config = loadConfig();
  if (!config.userName) {
    console.log(colors.red('Not configured. Run "npx nkspeedtest setup" first.'));
    process.exit(1);
  }

  const npxPath = execSync('which npx', { encoding: 'utf8' }).trim();
  const plist = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${PLIST_NAME}</string>
    <key>ProgramArguments</key>
    <array>
        <string>${npxPath}</string>
        <string>nkspeedtest</string>
        <string>run</string>
    </array>
    <key>StartInterval</key>
    <integer>${config.interval || 600}</integer>
    <key>RunAtLoad</key>
    <true/>
    <key>StandardOutPath</key>
    <string>${DATA_DIR}/launchd_stdout.log</string>
    <key>StandardErrorPath</key>
    <string>${DATA_DIR}/launchd_stderr.log</string>
</dict>
</plist>`;

  // Ensure LaunchAgents directory exists
  const launchAgentsDir = path.dirname(PLIST_PATH);
  if (!fs.existsSync(launchAgentsDir)) {
    fs.mkdirSync(launchAgentsDir, { recursive: true });
  }

  fs.writeFileSync(PLIST_PATH, plist);

  try { execSync(`launchctl unload "${PLIST_PATH}" 2>/dev/null`); } catch {}
  execSync(`launchctl load "${PLIST_PATH}"`);

  console.log(colors.green('Automatic monitoring started'));
  console.log(`Tests will run every ${(config.interval || 600) / 60} minutes`);
}

function cmdStop() {
  if (fs.existsSync(PLIST_PATH)) {
    try { execSync(`launchctl unload "${PLIST_PATH}"`); } catch {}
    fs.unlinkSync(PLIST_PATH);
    console.log(colors.green('Automatic monitoring stopped'));
  } else {
    console.log('Monitoring was not running');
  }
}

function cmdStatus() {
  printHeader();
  const config = loadConfig();

  console.log(colors.blue('Configuration:'));
  console.log(`  User:     ${config.userName || 'Not configured'}`);
  console.log(`  Server:   ${config.serverUrl || 'Local only'}`);
  console.log(`  Interval: ${(config.interval || 600) / 60} minutes`);
  console.log(`  Version:  ${VERSION}`);

  // Check monitoring status
  try {
    execSync(`launchctl list | grep -q "${PLIST_NAME}"`, { stdio: 'ignore' });
    console.log(`  Monitor:  ${colors.green('Running')}`);
  } catch {
    console.log(`  Monitor:  ${colors.yellow('Stopped')}`);
  }

  // Check menu bar status
  if (fs.existsSync(SWIFTBAR_PLUGIN_PATH)) {
    console.log(`  Menu Bar: ${colors.green('Installed')}`);
  } else {
    console.log(`  Menu Bar: ${colors.yellow('Not installed')} (run: npx nkspeedtest menubar)`);
  }

  console.log(colors.blue('\nRecent Results:'));
  if (fs.existsSync(CSV_FILE)) {
    const lines = fs.readFileSync(CSV_FILE, 'utf8').trim().split('\n').slice(-6);
    lines.slice(1).forEach((line) => {
      const [ts, date, time, user, host, down, up, ping] = line.split(',');
      if (time) {
        console.log(`  ${time} - Down: ${down}Mbps, Up: ${up}Mbps, Ping: ${ping}ms`);
      }
    });
  } else {
    console.log('  No data yet. Run: npx nkspeedtest run');
  }
}

async function cmdMenuBar() {
  printHeader();
  console.log(colors.blue('Installing menu bar widget...\n'));

  // Check and install SwiftBar
  if (!checkAndInstallSwiftBar()) {
    return;
  }

  // Create SwiftBar plugins directory if it doesn't exist
  if (!fs.existsSync(SWIFTBAR_PLUGINS_DIR)) {
    console.log(colors.blue('Creating SwiftBar plugins directory...'));
    fs.mkdirSync(SWIFTBAR_PLUGINS_DIR, { recursive: true });
  }

  // Auto-configure SwiftBar to use our plugins directory (skip the folder picker dialog)
  console.log(colors.blue('Configuring SwiftBar...'));
  try {
    execSync(`defaults write com.ameba.SwiftBar PluginDirectory "${SWIFTBAR_PLUGINS_DIR}"`, { stdio: 'ignore' });
    execSync('defaults write com.ameba.SwiftBar SUHasLaunchedBefore -bool true', { stdio: 'ignore' });
    execSync('defaults write com.ameba.SwiftBar MakePluginExecutable -bool true', { stdio: 'ignore' });
  } catch (err) {
    console.log(colors.yellow('Could not auto-configure SwiftBar preferences'));
  }

  // Generate the SwiftBar plugin (using array join to avoid template literal issues with $)
  const pluginLines = [
    '#!/bin/bash',
    '',
    '# NK Speed Test - SwiftBar Plugin',
    '# <swiftbar.hideAbout>true</swiftbar.hideAbout>',
    '# <swiftbar.hideRunInTerminal>true</swiftbar.hideRunInTerminal>',
    '# <swiftbar.hideLastUpdated>false</swiftbar.hideLastUpdated>',
    '# <swiftbar.hideDisablePlugin>true</swiftbar.hideDisablePlugin>',
    '# <swiftbar.hideSwiftBar>true</swiftbar.hideSwiftBar>',
    '',
    'CSV_FILE="$HOME/.local/share/nkspeedtest/speed_log.csv"',
    'CONFIG_FILE="$HOME/.config/nkspeedtest/config.json"',
    '',
    '# Get user name from config',
    'USER_NAME=""',
    'if [[ -f "$CONFIG_FILE" ]]; then',
    '    USER_NAME=$(grep -o \'"userName"[[:space:]]*:[[:space:]]*"[^"]*"\' "$CONFIG_FILE" | cut -d\'"\' -f4)',
    'fi',
    '',
    '# Get the latest entry from CSV',
    'if [[ -f "$CSV_FILE" ]]; then',
    '    LATEST=$(tail -1 "$CSV_FILE")',
    '',
    '    # Parse CSV',
    '    IFS=\',\' read -r timestamp date time user hostname download upload ping ssid ip status <<< "$LATEST"',
    '',
    '    # Trim whitespace',
    '    download=$(echo "$download" | xargs)',
    '    upload=$(echo "$upload" | xargs)',
    '    ping=$(echo "$ping" | xargs)',
    '    status=$(echo "$status" | xargs)',
    '    time=$(echo "$time" | xargs)',
    '',
    '    # Check if we have valid data',
    '    if [[ "$status" == "success" && -n "$download" ]]; then',
    '        echo "↓$download ↑$upload | sfimage=wifi"',
    '    else',
    '        echo "⚠ Offline | sfimage=wifi.slash"',
    '    fi',
    '',
    '    echo "---"',
    '    echo "NK Speed Test | size=14"',
    '    echo "---"',
    '    echo "Download: $download Mbps | sfimage=arrow.down.circle"',
    '    echo "Upload: $upload Mbps | sfimage=arrow.up.circle"',
    '    echo "Ping: $ping ms | sfimage=clock"',
    '    echo "---"',
    '    echo "User: ${USER_NAME:-$user} | sfimage=person"',
    '    echo "Last Test: $time | sfimage=calendar"',
    '    echo "---"',
    '    echo "Run Speed Test Now | bash=/usr/bin/env param1=npx param2=nkspeedtest param3=run terminal=false refresh=true sfimage=play.circle"',
    '    echo "Open Dashboard | bash=/usr/bin/env param1=npx param2=nkspeedtest param3=dashboard terminal=false sfimage=chart.line.uptrend.xyaxis"',
    '    echo "---"',
    '    echo "View Status | bash=/usr/bin/env param1=npx param2=nkspeedtest param3=status terminal=true sfimage=info.circle"',
    'else',
    '    echo "⚠ No Data | sfimage=wifi.slash"',
    '    echo "---"',
    '    echo "No speed test data yet"',
    '    echo "Run: npx nkspeedtest setup"',
    'fi',
  ];
  const pluginContent = pluginLines.join('\n');

  // Write the plugin
  fs.writeFileSync(SWIFTBAR_PLUGIN_PATH, pluginContent);
  fs.chmodSync(SWIFTBAR_PLUGIN_PATH, 0o755);

  console.log(colors.green('Menu bar widget installed!'));

  // Kill SwiftBar if running to force it to pick up new preferences
  console.log(colors.blue('Restarting SwiftBar...'));
  try {
    execSync('pkill -x SwiftBar 2>/dev/null || true', { stdio: 'ignore' });
  } catch {}

  // Wait a moment for it to fully quit
  execSync('sleep 1');

  // Start SwiftBar fresh
  console.log(colors.blue('Starting SwiftBar...'));
  execSync('open -a SwiftBar', { stdio: 'ignore' });

  // Wait for it to start and refresh
  execSync('sleep 2');
  try {
    execSync('open -g swiftbar://refreshallplugins', { stdio: 'ignore' });
  } catch {}

  console.log(colors.green('\nDone! You should see the speed widget in your menu bar.'));
  console.log(`
If not visible, check these macOS settings:
  1. System Settings → Privacy & Security → Accessibility → Enable SwiftBar
  2. System Settings → Privacy & Security → Automation → Allow SwiftBar
  3. If SwiftBar asks for a folder, select: ~/Library/Application Support/SwiftBar/Plugins
`);
}

function cmdUpdate() {
  printHeader();
  console.log(colors.blue('Checking for updates...\n'));

  try {
    // Clear npm cache for this package and update
    console.log(colors.blue('Updating nkspeedtest...'));
    execSync('npm cache clean --force nkspeedtest 2>/dev/null || true', { stdio: 'ignore' });

    const result = execSync('npm show nkspeedtest version 2>/dev/null', { encoding: 'utf8' }).trim();

    if (result && result !== VERSION) {
      console.log(colors.yellow(`New version available: ${result} (current: ${VERSION})`));
      console.log(colors.blue('Installing update...'));
      execSync('npm install -g nkspeedtest@latest', { stdio: 'inherit' });
      console.log(colors.green('\nUpdate complete! Run "npx nkspeedtest --version" to verify.'));

      // Update menu bar plugin if installed
      if (fs.existsSync(SWIFTBAR_PLUGIN_PATH)) {
        console.log(colors.blue('Updating menu bar widget...'));
        cmdMenuBar();
      }
    } else if (result) {
      console.log(colors.green(`You're already on the latest version (${VERSION})`));
    } else {
      console.log(colors.yellow('Could not check for updates. Try: npm update -g nkspeedtest'));
    }
  } catch (err) {
    console.log(colors.yellow('Could not check for updates online.'));
    console.log('To manually update, run: npm install -g nkspeedtest@latest');
  }
}

function cmdLogs() {
  if (fs.existsSync(LOG_FILE)) {
    const lines = fs.readFileSync(LOG_FILE, 'utf8').trim().split('\n').slice(-20);
    lines.forEach((l) => console.log(l));
  } else {
    console.log('No logs yet');
  }
}

function cmdDashboard() {
  ensureDirs();

  const dashboardLines = [
    '<!DOCTYPE html>',
    '<html><head><meta charset="UTF-8"><title>NK Speed Test</title>',
    '<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>',
    '<style>',
    '*{margin:0;padding:0;box-sizing:border-box}',
    'body{font-family:system-ui;background:#1a1a2e;color:#eee;padding:20px}',
    'h1{color:#00d4ff;margin-bottom:10px}',
    '.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}',
    '.filter-box{display:flex;align-items:center;gap:10px}',
    'select{background:#16213e;color:#eee;border:1px solid #00d4ff;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer}',
    'select:focus{outline:none;border-color:#00ff88}',
    '.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}',
    '.card{background:#16213e;border-radius:12px;padding:20px;text-align:center}',
    '.val{font-size:2rem;color:#00d4ff}',
    '.label{color:#888;font-size:0.9rem}',
    '.chart-box{background:#16213e;border-radius:12px;padding:20px;margin-bottom:20px}',
    'canvas{max-height:300px}',
    '.network-info{background:#16213e;border-radius:12px;padding:15px;margin-bottom:20px}',
    '.network-info h3{color:#00d4ff;margin-bottom:10px}',
    '.ssid-list{display:flex;flex-wrap:wrap;gap:10px}',
    '.ssid-tag{background:#0d1526;padding:8px 12px;border-radius:20px;font-size:0.85rem}',
    '.ssid-tag .count{color:#00d4ff;margin-left:5px}',
    '</style></head>',
    '<body>',
    '<div class="header">',
    '  <h1>NK Speed Test Dashboard</h1>',
    '  <div class="filter-box">',
    '    <label>Filter by Network:</label>',
    '    <select id="ssidFilter" onchange="filterData()">',
    '      <option value="all">All Networks</option>',
    '    </select>',
    '  </div>',
    '</div>',
    '<div class="stats">',
    '  <div class="card"><div class="val" id="avgD">--</div><div class="label">Avg Download (Mbps)</div></div>',
    '  <div class="card"><div class="val" id="avgU">--</div><div class="label">Avg Upload (Mbps)</div></div>',
    '  <div class="card"><div class="val" id="avgP">--</div><div class="label">Avg Ping (ms)</div></div>',
    '  <div class="card"><div class="val" id="cnt">--</div><div class="label">Tests</div></div>',
    '</div>',
    '<div class="network-info">',
    '  <h3>Networks Detected</h3>',
    '  <div class="ssid-list" id="ssidList"></div>',
    '</div>',
    '<div class="chart-box"><canvas id="chart"></canvas></div>',
    '<script>',
    'let allData = [];',
    'let chart = null;',
    '',
    'async function loadData() {',
    '  const response = await fetch("speed_log.csv");',
    '  const text = await response.text();',
    '  const lines = text.trim().split("\\n");',
    '  allData = lines.slice(1).map(row => {',
    '    const c = row.split(",");',
    '    return {',
    '      time: c[2],',
    '      date: c[1],',
    '      user: c[3],',
    '      down: +c[5],',
    '      up: +c[6],',
    '      ping: +c[7],',
    '      ssid: c[8],',
    '      status: c[10]',
    '    };',
    '  }).filter(x => x.status === "success");',
    '',
    '  // Populate SSID filter',
    '  const ssids = [...new Set(allData.map(d => d.ssid))];',
    '  const select = document.getElementById("ssidFilter");',
    '  ssids.forEach(ssid => {',
    '    const opt = document.createElement("option");',
    '    opt.value = ssid;',
    '    opt.textContent = ssid;',
    '    select.appendChild(opt);',
    '  });',
    '',
    '  // Show SSID tags',
    '  const ssidCounts = {};',
    '  allData.forEach(d => { ssidCounts[d.ssid] = (ssidCounts[d.ssid] || 0) + 1; });',
    '  const ssidList = document.getElementById("ssidList");',
    '  ssidList.innerHTML = Object.entries(ssidCounts).map(([ssid, count]) =>',
    '    `<div class="ssid-tag">${ssid}<span class="count">(${count})</span></div>`',
    '  ).join("");',
    '',
    '  filterData();',
    '}',
    '',
    'function filterData() {',
    '  const filter = document.getElementById("ssidFilter").value;',
    '  const data = filter === "all" ? allData : allData.filter(d => d.ssid === filter);',
    '',
    '  if (!data.length) return;',
    '',
    '  const recent = data.slice(-50);',
    '  document.getElementById("avgD").textContent = (data.reduce((s,x) => s+x.down, 0) / data.length).toFixed(1);',
    '  document.getElementById("avgU").textContent = (data.reduce((s,x) => s+x.up, 0) / data.length).toFixed(1);',
    '  document.getElementById("avgP").textContent = (data.reduce((s,x) => s+x.ping, 0) / data.length).toFixed(1);',
    '  document.getElementById("cnt").textContent = data.length;',
    '',
    '  if (chart) chart.destroy();',
    '  chart = new Chart(document.getElementById("chart"), {',
    '    type: "line",',
    '    data: {',
    '      labels: recent.map(x => x.time),',
    '      datasets: [',
    '        {label: "Download", data: recent.map(x => x.down), borderColor: "#00d4ff", tension: 0.3},',
    '        {label: "Upload", data: recent.map(x => x.up), borderColor: "#00ff88", tension: 0.3}',
    '      ]',
    '    },',
    '    options: {',
    '      responsive: true,',
    '      plugins: {legend: {labels: {color: "#888"}}},',
    '      scales: {x: {ticks: {color: "#666"}}, y: {ticks: {color: "#666"}}}',
    '    }',
    '  });',
    '}',
    '',
    'loadData();',
    '</script>',
    '</body></html>',
  ];

  const dashboardHtml = dashboardLines.join('\n');
  fs.writeFileSync(path.join(DATA_DIR, 'dashboard.html'), dashboardHtml);

  // Kill any existing server on port 8765
  try { execSync('lsof -ti:8765 | xargs kill -9 2>/dev/null', { stdio: 'ignore' }); } catch {}

  console.log('Starting dashboard at http://localhost:8765');
  const server = spawn('python3', ['-m', 'http.server', '8765'], { cwd: DATA_DIR, detached: true, stdio: 'ignore' });
  server.unref();

  setTimeout(() => {
    execSync('open http://localhost:8765/dashboard.html');
  }, 1000);
}

async function cmdUninstall() {
  printHeader();
  const confirm = await promptYesNo('This will remove nkspeedtest configuration. Continue?', false);

  if (confirm) {
    // Stop monitoring
    cmdStop();

    // Remove SwiftBar plugin
    if (fs.existsSync(SWIFTBAR_PLUGIN_PATH)) {
      fs.unlinkSync(SWIFTBAR_PLUGIN_PATH);
      console.log(colors.green('Menu bar widget removed'));
    }

    // Remove config
    if (fs.existsSync(CONFIG_DIR)) {
      fs.rmSync(CONFIG_DIR, { recursive: true });
    }

    console.log(colors.green('Configuration removed.'));
    console.log(`Data preserved at: ${DATA_DIR}`);
    console.log(`To fully remove data, run: rm -rf "${DATA_DIR}"`);
  } else {
    console.log('Cancelled');
  }
}

// Main
const cmd = process.argv[2];

switch (cmd) {
  case 'setup': cmdSetup(); break;
  case 'run': cmdRun(); break;
  case 'start': cmdStart(); break;
  case 'stop': cmdStop(); break;
  case 'status': cmdStatus(); break;
  case 'menubar': cmdMenuBar(); break;
  case 'logs': cmdLogs(); break;
  case 'dashboard': cmdDashboard(); break;
  case 'update': cmdUpdate(); break;
  case 'uninstall': cmdUninstall(); break;
  case '-v': case '--version': console.log(`nkspeedtest v${VERSION}`); break;
  case '-h': case '--help': case undefined: usage(); break;
  default:
    console.log(colors.red(`Unknown command: ${cmd}`));
    usage();
    process.exit(1);
}
